"use strict";

module.exports = function handleConnection(socket, request, socketRegistry) {
  var url = request.url.slice(1); // remove leading '/'
  socket.on("close", function () {
    socketRegistry.delete(url);
  });
  socket.on("error", function () {
    socketRegistry.delete(url);
  });

  try {
    var handler = socketRegistry.get(url);
    if (handler != null) {
      handler(socket, request);
    } else {
      socket.close(4404, "No websocket handler is registered for that URL.");
    }
  } catch (err) {
    // According to RFC6455, a WebSocket control frame must be 125 bytes or
    // smaller, and in a Close control frame, the first two bytes are the
    // status code (in this case, 4500). That leaves 123 bytes left for the
    // reason string.
    var maxReasonSize = 123;
    socket.close(4500, err.stack.replace(/\n {4}at/g, "\nat").slice(0, maxReasonSize));
  }
};