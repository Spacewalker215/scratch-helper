"use strict";

var _promise = require("babel-runtime/core-js/promise");

var _promise2 = _interopRequireDefault(_promise);

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

var createFakeModuleEnvironment = require("./createFakeModuleEnvironment");
var parseRequest = require("./parseRequest");
var compileCode = require("./compileCode");
var wrapRequireForSocket = require("./wrapRequireForSocket");


module.exports = function handleRequest(requestBody, serverConfig, requestUrl, socketRegistry) {
  return new _promise2.default(function (resolve, reject) {
    var idMappings = serverConfig && serverConfig.idMappings;

    var _parseRequest = parseRequest(requestBody, idMappings),
        code = _parseRequest.code,
        args = _parseRequest.args;

    var runCode = compileCode(code, args);

    var requireFrom = serverConfig && serverConfig.requireFrom;
    var env = createFakeModuleEnvironment(requireFrom);

    env.require = wrapRequireForSocket(env.require, requestUrl, socketRegistry);

    var result = runCode(env);
    resolve(result);
  });
};